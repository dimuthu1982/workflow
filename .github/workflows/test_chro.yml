name: Merge branch to master
run-name: Merge ${{ github.head_ref }} to master (release) 🏷️
on: [push]
jobs:
  extract-tag-in-branch:
     #if: ${{ startsWith(github.head_ref, 'release/') }}
     name: Tag From Latest Version
     runs-on: ubuntu-latest
     #outputs:
     #  TAG_NAME: ${{steps.release_in_branch.outputs.TAG_NAME}}
     #  RELEASE_TYPE: ${{steps.release_type.outputs.RELEASE_TYPE}}
     steps:
        - uses: actions/checkout@v4
        - if: ${{ startsWith(github.head_ref, 'release/') }}
          name: Find Release Version From Branch
          id: release_in_branch
          run: | 
            currentBranch="${{github.head_ref}}"
            echo "Branch Name - ${currentBranch}"
            extractedVersion=${currentBranch/'release/'}
            echo "Extracted Version - ${extractedVersion}"
            echo "TAG_NAME=$extractedVersion" >> $GITHUB_OUTPUT

        - if: ${{ !steps.release_in_branch.outputs.TAG_NAME }}
          name: Find Release version By Branch
          id: release_type
          run: |
            currentBranch="${{ github.head_ref }}" 
            currentBranch="release" #TBR
             if [[ $currentBranch == 'release' ]]; then 
              echo "Identifyed as minor release"
              echo "RELEASE_TYPE=minor" >> $GITHUB_OUTPUT
             elif [[ $currentBranch == 'hotfix/' ]]; then 
              echo "Identifyed as patch release"
              echo "RELEASE_TYPE=patch" >> $GITHUB_OUTPUT
             else 
              exit 0;
             fi

        - if: ${{ steps.release_type.outputs.RELEASE_TYPE }}
          name: Initiating Next Version Lookup
          id: next_version_by_branch
          uses: reecetech/version-increment@2023.10.1
          with:
              use_api: true
              increment: ${{ steps.release_type.outputs.RELEASE_TYPE }}
        - run: echo "TAG_NAME=${{ steps.next_version_by_branch.outputs.version }}" >> $GITHUB_OUTPUT

        - name: Print Tag
          run: | 
            echo " Release_Tag - ${{ steps.release_in_branch.outputs.TAG_NAME }}"
            echo "Name before tag RELEASE_TYPE - ${{ steps.release_type.outputs.RELEASE_TYPE }}"
            echo "Release Version By Branch - ${{ steps.next_version_by_branch.outputs.TAG_NAME }}"
            echo "Release Version By Branch v1 -${{ steps.next_version_by_branch.outputs.version }}"

        - if: ${{ steps.release_in_branch.outputs.TAG_NAME }}
          name: Create Tag
          run: |
            RELEASING_TAG=${{ steps.release_in_branch.outputs.TAG_NAME }}
            echo "Next Tag - $RELEASING_TAG"
            git config --global user.name ${{ github.triggering_actor }}
            git config --global user.email dimuthu.abeynayakage@sportsbet.com.au
            git tag $RELEASING_TAG
            git push --tags
