name: Merge branch to master
run-name: Merge ${{ github.head_ref }} to master (release) ðŸ·ï¸
on: [push]
jobs:
  extract-tag-in-branch:
     #if: ${{ startsWith(github.head_ref, 'release/') }}
     name: Tag From Latest Version
     runs-on: ubuntu-latest
     #outputs:
     #  TAG_NAME: ${{steps.release_in_branch.outputs.TAG_NAME}}
     #  RELEASE_TYPE: ${{steps.release_by_branch.outputs.RELEASE_TYPE}}
     steps:
        - uses: actions/checkout@v4
        - if: ${{ startsWith(github.head_ref, 'release/') }} || true
          name: Find Release Version From Branch
          id: release_in_branch
          run: | 
            currentBranch="${{github.head_ref}}"
            currentBranch="release/1.5.0" #TBR
            echo "Branch Name - ${currentBranch}"
            extractedVersion=${currentBranch/'release/'}
            echo "Extracted Version - ${extractedVersion}"
            echo "TAG_NAME=$extractedVersion" >> $GITHUB_OUTPUT

        - if: ${{ !env.TAG_NAME }}
          name: Find Release version By Branch
          id: release_by_branch
          run: |
            currentBranch="${{ github.head_ref }}" 
            currentBranch="hotfix/" #TBR
             if [[ $currentBranch == 'release' ]]; then 
              echo "Identifyed as minor release"
              echo "RELEASE_TYPE=minor" >> $GITHUB_OUTPUT
             elif [[ $currentBranch == 'hotfix/' ]]; then 
              echo "Identifyed as patch release"
                #releaseType="patch"
                 echo "RELEASE_TYPE=patch" >> $GITHUB_OUTPUT
             else 
              exit 0;
             fi
            #echo "RELEASE_TYPE=$releaseType" >> $GITHUB_OUTPUT

        #- if: ${{ startsWith(github.head_ref, 'hotfix/') }}
        #  name: Release Branch
        #  id: release_type2
        #  run: echo "RELEASE_TYPE=patch" >> $GITHUB_ENV

        - name: Print Tag
          run: | 
            echo " Release_Tag - ${{steps.release_in_branch.outputs.TAG_NAME}}"
            echo "Name before tag RELEASE_TYPE - ${{steps.release_by_branch.outputs.RELEASE_TYPE}}"

        - if: ${{ env.RELEASE_TYPE }}
          name: Initiating Next Version Lookup
          uses: reecetech/version-increment@2023.10.1
          with:
              use_api: true
              increment: ${{ env.RELEASE_TYPE }}
        - run: echo "TAG_NAME=${{ steps.release_version.outputs.TAG_NAME }}" >> $GITHUB_ENV

        - if: ${{ env.TAG_NAME }}
          name: Create Tag
          run: |
            RELEASING_TAG=${{ env.TAG_NAME }}
            echo "Next Tag - $RELEASING_TAG"
            git config --global user.name ${{ github.triggering_actor }}
            git config --global user.email dimuthu.abeynayakage@sportsbet.com.au
            git tag $RELEASING_TAG
            git push --tags
